
# å…³äºå°ç¨‹åºçš„æ¢ç´¢

## å¼€å§‹çš„æ–¹æ¡ˆ

å½“æ—¶å…¬å¸å‡†å¤‡å¼€å§‹å†…éƒ¨è‡ªç ”å°ç¨‹åºæŠ€æœ¯æ–¹æ¡ˆï¼Œæ•´ä¸ªå¼€å‘æ–¹å¼éƒ½æ˜¯å’Œwxå°ç¨‹åºä¿æŒä¸€è‡´çš„ï¼Œä¸šåŠ¡å¼€å‘æ˜¯ä¹Ÿæ˜¯æ¨¡ç‰ˆã€æ ·å¼ã€é€»è¾‘ã€é…ç½®ç­‰ç­‰ï¼ŒåŸºæœ¬ç¡®å®šäº†å¯¹å¤–çš„æ¥å…¥æ–¹å¼ã€‚

ç”±äºåœ¨æ­¤ä¹‹å‰å·²ç»æœ‰ä¸€ç‰ˆhybridæ–¹æ¡ˆé‡‡ç”¨çš„ä¹Ÿæ˜¯åŒçº¿ç¨‹æ–¹æ¡ˆï¼Œä¸šåŠ¡é€»è¾‘å±‚å’Œè§†å›¾æ¸²æŸ“å±‚éš”ç¦»ï¼Œä»è¿™ä¸ªè§†è§’çœ‹æ¶æ„ä¸å°ç¨‹åºæ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯å®ƒçš„é€»è¾‘å±‚å…¶å®åˆä¸å°ç¨‹åºä¸å¤ªä¸€æ ·ï¼Œé€»è¾‘å±‚åšçš„äº‹æƒ…æ¯”è¾ƒå¤šï¼ŒæŠŠæ•´ä¸ªåº”ç”¨çš„æ‰§è¡Œå…¨éƒ¨æ”¾åœ¨äº†é€»è¾‘å±‚ï¼Œå½¢è±¡çš„æ¯”å–»é‚£å°±æ˜¯ä¸€ä¸ªwebviewç‰ˆæ¸²æŸ“çš„ReactNativeğŸ˜“ã€‚

<img src="./images/hybrid3æµç¨‹.png" />


å› æ­¤è¿™ç‰ˆå°ç¨‹åºçš„æœ€ç»ˆè¿è¡Œæœºåˆ¶æ˜¯è¦å¾€hybridä¸Šé ï¼Œé€šä¿—æ˜“æ‡‚çš„è§£é‡Šå°±æ˜¯å°†å°ç¨‹åºç¡¬è½¬è¯‘ä¸ºReactï¼Œå¯¹å°ç¨‹åºä¸€ç›´ä¿æŒä¸€äº›å…³æ³¨æ‰€ä»¥ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯Taroï¼Œè®°å¾—Taroæœ‰ä¸ª[convertåŠŸèƒ½](https://taro-docs.jd.com/taro/docs/taroize)å¤§è‡´ç¬¦åˆéœ€æ±‚å°†å°ç¨‹åºè½¬æˆç±»Reactï¼Œå°ç¨‹åºæ•´ä½“æ–¹æ¡ˆåŸºæœ¬å®šäº†ï¼Œåé¢å¯ä»¥å¼€å§‹ç€æ‰‹è¸©å…¶ä¸­çš„å‘äº†ã€‚

## é‡åˆ°çš„é—®é¢˜

- é™æ€è½¬è¯‘ä¸èƒ½è§£å†³çš„é—®é¢˜

taroçš„convertåŠŸèƒ½æ²¡æœ‰è¦†ç›–æ‰€æœ‰çš„å°ç¨‹åºå†™æ³•ï¼Œæ¯”å¦‚templateæ·±åº¦åµŒå¥—ã€templateä¼ å€¼æ–¹å¼ç­‰ç­‰é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å…¶å®è¿˜å¥½å¯ä»¥é­”æ”¹ä¸€ä¸‹ã€‚

ä¸šåŠ¡ä»£ç ä¸­çš„Pageã€Componentç­‰å‡½æ•°è°ƒç”¨è¯­æ³•æ˜¯è½¬è¯‘çš„å…³é”®è¯­æ³•ï¼Œä¸€æ—¦ä¸šåŠ¡æ–¹çš„å°ç¨‹åºä½¿ç”¨äº†ç±»ä¼¼wepyè¿™æ ·çš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œæˆ–è€…è‡ªå·±å°è£…äº†Pageã€Componentç­‰å‡½æ•°è°ƒç”¨ï¼Œé™æ€è½¬è¯‘å°†åœ¨æŒ‡å®šä»£ç ä¸­æ‰¾ä¸åˆ°å…³é”®å­—ã€‚å› æ­¤é™æ€è½¬è¯‘ä¸æ˜¯é“¶å¼¹ï¼Œè¿™ä¸€ç‰ˆå°ç¨‹åºå¯¹ä¸šåŠ¡å¼€å‘è€…ä½¿ç”¨ä¸Šå­˜åœ¨å¾ˆå¤§çš„é™åˆ¶ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å°ç¨‹åºæ–¹æ¡ˆã€‚

```js
// myPage.js
function myPage(config) {
  // do sth
  Page(config)
}

// page1.js
import myPage from '@common/myPage'

myPage({})
```

- é€»è¾‘å±‚è¿‡é‡

å°†æ•´ä¸ªReactåº”ç”¨å…¨éƒ¨æ”¾åœ¨äº†é€»è¾‘å±‚ï¼Œå…¶ä¸­ä¹ŸåŒ…å«äº†å†…ç½®ç»„ä»¶ï¼Œè¿™æ ·å¸¦æ¥äº†ä¸€äº›é—®é¢˜ã€‚

åŸæœ¬å†…ç½®ç»„ä»¶æ˜¯å—ä¿¡ä»»çš„ï¼Œç”±äºä¹Ÿåœ¨é€»è¾‘å±‚ä¸­ï¼Œå¯¼è‡´è¿™äº›ç»„ä»¶ä¹Ÿå—åˆ°äº†DOMã€BOMçš„é™åˆ¶ï¼Œè‡ªå·±ç¡¬ç»™è‡ªå·±è®¾äº†ä¸€é“åã€‚ä¸ºäº†è®©å†…ç½®ç»„ä»¶æ¢å¤æ­£å¸¸èƒ½åŠ›ï¼Œé€»è¾‘å±‚çš„å†…ç½®ç»„ä»¶å¯ä»¥ä¸å»å®ç°å…·ä½“çš„åŠŸèƒ½ï¼Œåªè´Ÿè´£äº‹ä»¶çš„æ¥æ”¶ä¼ é€’ï¼Œåœ¨æ¸²æŸ“å±‚é€šè¿‡web-componentå»å®ç°ä¸€ä¸ªå…·ä½“åŠŸèƒ½çš„ç»„ä»¶ã€‚

è¿™ç§æ–¹å¼å¯¹äºæ¡†æ¶å¼€å‘è€…æ¥è¯´ä½“éªŒè¿˜æ˜¯å¤ªå·®äº†ã€‚

<img src="./images/hybrid3å†…ç½®ç»„ä»¶.png" />

å› æ­¤è¿™ä¸ªæ–¹æ¡ˆä¸æ˜¯ä¸€ä¸ªå¯æŒç»­å‘å±•çš„æ–¹æ¡ˆï¼Œéœ€è¦æ”¹å˜ä¸€ä¸‹æ–¹å‘ã€‚

## å†æ¬¡æ¢ç´¢å°ç¨‹åº

ç»è¿‡ä¸Šä¸€é˜¶æ®µçš„è¸©å‘ï¼ŒåŸºäºtaroåšå°ç¨‹åºçš„è¿è¡Œæ—¶æ–¹æ¡ˆè‚¯å®šæ˜¯ä¸å¤ªæ­£ç¡®çš„ã€‚å› æ­¤æƒ³åšå°ç¨‹åºå°±å¾—ä¸ä¸šç•Œå¯¹é½ï¼Œæ¢ç´¢ä¸šç•Œæ˜¯æ€ä¹ˆå®ç°çš„ã€‚

å°ç¨‹åºæ•´ä½“æ¶æ„ä¸»è¦ç”±åŸºç¡€åº“ã€ç¼–è¯‘å™¨ã€å®¿ä¸»å®¹å™¨ç»„æˆ

<img src="./images/å°ç¨‹åºåŸç†.png" /> 


### æ¸²æŸ“å±‚

**ä¸»è¦èŒè´£ï¼š** æ‰¿è½½æ¨¡ç‰ˆå’Œæ ·å¼çš„å±•ç¤ºåŠŸèƒ½

**åŒ…å«æ¨¡å—ï¼š** UIæ¡†æ¶ã€å†…ç½®ç»„ä»¶

- UIæ¡†æ¶ï¼š Reactã€Vueç­‰ç›®å‰ä¸»æµæ¡†æ¶
  * å¾®ä¿¡å°ç¨‹åºExparserï¼ˆæœªå¼€æºï¼‰
  * æ”¯ä»˜å®å°ç¨‹åºReact
  * ç™¾åº¦å°ç¨‹åºswan.js
  * å­—èŠ‚å°ç¨‹åºYaw ç±»Reactï¼ˆæœªå¼€æºï¼‰

- å†…ç½®ç»„ä»¶ï¼š
  * åŸºäºUIæ¡†æ¶å®ç°
  * åŸºäºweb-componentå®ç°ï¼ˆå­—èŠ‚å°ç¨‹åºåŸºäºPolymerï¼‰

### é€»è¾‘å±‚

**ä¸»è¦èŒè´£ï¼š** APIæä¾›ã€æ ¸å¿ƒé€»è¾‘æ‰§è¡Œä»¥åŠè·¯ç”±/äº‹ä»¶ç®¡ç†

**åŒ…å«æ¨¡å—ï¼š** 
  - Appã€Pageä»¥åŠComponentç­‰é€šç”¨æ–¹æ³•
  - è·¯ç”±
  - API

### ä¾‹å¦‚æ”¯ä»˜å®å°ç¨‹åº

webviewæ¸²æŸ“åŸºäºReactã€React-DOMï¼Œå†…ç½®ç»„ä»¶ä¸ºReactç»„ä»¶ã€‚

ä¸šåŠ¡ä»£ç çš„æ¨¡ç‰ˆæ–‡ä»¶ä¸æ ·å¼æ–‡ä»¶ä¼šæ‰“åŒ…åˆ°webviewï¼Œä¾‹å¦‚ï¼š

```js
// index.webview.js
Component({
  usingComponents: {
    
  },
  get render() {
    return require('root/components/a/a.axml')
  },
  get style() {
    return require('root/components/a/a.acss')
  }
})

Page({
  usingComponents: {
    'com-a': 'root/components/a'
  },
  get render() {
    return require('root/pages/index/index.axml')
  },
  get style() {
    return require('root/pages/index/index.acss')
  }
})

```

ä¸šåŠ¡ä»£ç çš„é€»è¾‘æ–‡ä»¶ä¼šæ‰“åŒ…åˆ°serviceï¼Œä¾‹å¦‚ï¼š

```js
// index.service.js
require('root/app.js');
require('root/components/a/a.js');
require('root/pages/index/index.js');
```

## å®ç°

### é€‰å‹
UIæ¡†æ¶çš„é€‰æ‹©ä½¿ç”¨æ¯”è¾ƒç†Ÿæ‚‰Reactï¼Œå†…ç½®ç»„ä»¶éƒ¨åˆ†æœŸæœ›åšåˆ°æ¯”è¾ƒçº¯ç²¹ã€éš”ç¦»ï¼Œæ‰€ä»¥web-componentæ˜¯åˆé€‚çš„é€‰æ‹©ï¼Œä¸ºäº†ç»„ä»¶å¼€å‘æ–¹ä¾¿é€‰æ‹©äº†Polymerã€‚

### è‡ªå®šä¹‰æ¸²æŸ“å™¨
å…ˆçœ‹ä¸‹å°ç¨‹åºæºç åˆ°æœ€ç»ˆå¤„ç†åèƒ½è¿è¡Œçš„äº§ç‰©æ˜¯æ€æ ·çš„ï¼Œ ä»¥é¡µé¢æ–‡ä»¶ä¸¾ä¾‹ï¼š

**root/pages/index/index.wxmlï¼š**
```html 
<view style="width: 100rpx">
  <button class="btn" bind:tap="onTap">click</button>
</view>  
<custom-component></custom-component>
```

**root/pages/index/index.wxssï¼š**
```css
.btn {
  color: red;
}
```

**root/pages/index/index.jsonï¼š**
```js
{
  usingComponents: {
    "custom-component": "/components/custom-component/index"
  }
}
```

**biz/index.webview.jsï¼š**

```js
const jsx = (data, ctx) => {
  // è‡ªå®šä¹‰ç»„ä»¶çš„çš„åŠ è½½
  const CustomComponent = ctx.resolveComponent('custom-component')

  return (
    <>
      <tiny-view style="width: 100rpx">
        <tiny-button class="btn" bind:tap={ctx.eventBinder('onTap')} >click</tiny-button>
      </tiny-view>
      <CustomComponent />
    </>
  )
} 

const css = () => `
.btn {
  color: red;
}
`

window.app['pages/index/index'] = {
  usingComponents: {
    "custom-component": "/components/custom-component/index"
  },
  render() {
    return jsx();
  },
  style() {
    return css();
  }
}

```

é€»è¾‘æ–‡ä»¶çš„ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨æ‰§è¡ŒPageæˆ–Componentè°ƒç”¨æ—¶æœ‰å¯¹åº”çš„æ ‡è¯†ï¼Œå¯ä»¥æ‰§è¡Œå‰æ·»åŠ æ³¨å†Œé€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

**biz/index.service.jsï¼š**
```js
// åŠ è½½app.js
require('app.js')

// åŠ è½½è‡ªå®šä¹‰ç»„ä»¶
$global.currentPageConfig = {
  is: "/components/custom-component/index",
  usingComponents: {}
};
require('components/custom-component/index.js')

// åŠ è½½é¡µé¢
$global.currentPageConfig = {
  is: "pages/index/index",
  usingComponents: {
    ""
  }
};
require('pages/index/index.js')

```

åŒç†è‡ªå®šä¹‰ç»„ä»¶éƒ¨åˆ†çš„ç¼–è¯‘å¤„ç†ä¹Ÿä¸ä¸Šé¢ç±»ä¼¼ã€‚

åˆ°è¿™é‡Œæœ‰æ²¡æœ‰æ³¨æ„åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œtmplateè½¬jsxåä¸ºä»€ä¹ˆstyleå±æ€§å’Œäº‹ä»¶ç»‘å®šæ²¡æœ‰ä½¿ç”¨Reactçš„äº‹ä»¶ç³»ç»Ÿå‘¢ï¼Œè¿™ä¸ªé—®é¢˜å…¶å®ä¸€å¼€å§‹æ˜¯React+ReactDOMå®ç°çš„ï¼Œä½†æ˜¯åæœŸå®Œå–„çš„è¿‡ç¨‹ä¸­è¢«ReactDOMé™åˆ¶äº†å¾ˆå¤šï¼Œæ¯”å¦‚bind:longpressè¿™æ ·çš„äº‹ä»¶åœ¨ReactDOMä¸­æ²¡æœ‰ä¸€ä¸€å¯¹åº”çš„ï¼Œè¿™é‡Œéœ€è¦è‡ªå·±å®ç°ä¸€ä¸‹[å°ç¨‹åºäº‹ä»¶ç³»ç»Ÿ](https://kms.netease.com/article/39017)ä»¥åŠstyleç­‰å±æ€§çš„å¤„ç†ï¼ˆå¦‚ï¼šrpx2pxã€æ ·å¼ä½œç”¨åŸŸï¼‰ï¼Œå…·ä½“æ–¹æ¡ˆå¯ä»¥ä½¿ç”¨react-reconcilerç¼–å†™ä¸€ä¸ª[è‡ªå®šä¹‰æ¸²æŸ“å™¨](https://g.hz.netease.com/jiyufeng/custom-renderer)ï¼Œä¹Ÿå¯ä»¥åŸºäºç¤¾åŒºçš„mini Reactåº“ä¿®æ”¹æ¸²æŸ“å™¨éƒ¨åˆ†ï¼Œå¦‚åŸºäºNervjsçš„å®ç°æˆæœ¬å°±å¾ˆä½ã€‚

### æ‰§è¡Œæµç¨‹

å°ç¨‹åºçš„ä¸šåŠ¡ä»£ç æœ€ç»ˆè¿è¡Œäº§ç‰©å·²ç»å®šäº†ï¼Œæ¥ä¸‹æ¥åœ¨å®ç°åŸºç¡€åº“ä¹‹å‰ï¼Œå¯ä»¥æ¢³ç†ä¸€ä¸‹å°ç¨‹åºçš„æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ã€‚

<img src="./images/å°ç¨‹åºæ‰§è¡Œæµç¨‹.png" />

### JSBridge

æ•´ä¸ªæµç¨‹ä¸­å¯ä»¥çœ‹åˆ°å°ç¨‹åºçš„åŒçº¿ç¨‹æ¨¡å‹ï¼Œæ¶‰åŠåˆ°å¤§é‡çš„é€šä¿¡è¿‡ç¨‹
- WebView -> Service
- Service -> WebView
- WebView -> Native
- Service -> Native

æ‰€ä»¥éœ€è¦è®¾è®¡ä¸€å¥—åˆé€‚çš„[å°ç¨‹åºJSBridgeæ–¹æ¡ˆ](https://kms.netease.com/article/41521)ï¼Œ è¿™æ˜¯åŸºç¡€åº“çš„é‡è¦ä¸€éƒ¨åˆ†ã€‚


## å‚è€ƒèµ„æ–™
- [react-reconciler](https://github.com/facebook/react/tree/main/packages/react-reconciler)
- [nervjs](https://github.com/NervJS/nerv/tree/master/packages/nerv)
- [æµè§ˆå™¨è‡ªå®šä¹‰äº‹ä»¶](https://developer.mozilla.org/zh-CN/docs/Web/API/CustomEvent)
- [H5å’ŒNativeäº¤äº’åŸç†](https://github.com/quickhybrid/quickhybrid/issues/10)
- [JSBridgeçš„å®ç°](https://github.com/quickhybrid/quickhybrid/issues/9)
- [EMPé€šä¿¡æœºåˆ¶](https://zhaomenghuan.js.org/blog/what-is-emp.html#%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6)
- [æ”¯ä»˜å®å°ç¨‹åº](https://opendocs.alipay.com/mini/ide/overview)
- [å­—èŠ‚å°ç¨‹åº](https://microapp.bytedance.com/docs/zh-CN/mini-app/develop/developer-instrument/overview)